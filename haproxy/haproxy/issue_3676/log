
#######################
# Get Haproxy version #
#######################


proxy-1-centos-7 :

HA-Proxy version 1.5.18 2016/05/10
Copyright 2000-2016 Willy Tarreau <willy@haproxy.org>


proxy-2-debian-9 :

HA-Proxy version 1.7.5-2 2017/05/17
Copyright 2000-2017 Willy Tarreau <willy@haproxy.org>


######################
# IP's of containers #
######################

proxy-1-centos-7:                    "IPAddress": "172.28.5.4",
proxy-2-debian-9:                    "IPAddress": "172.28.5.5",
redis-1-centos-7:                    "IPAddress": "172.28.5.0",
redis-2-centos-7:                    "IPAddress": "172.28.5.1",
redis-3-centos-7:                    "IPAddress": "172.28.5.2",

#################################################
# Apply Haproxy conf (with 'tcp-check connect') #
#################################################

proxy-1-centos-7.... done
proxy-2-debian-9.... done

########################
# Haproxy conf applied #
########################

global
  log /dev/log local2
  stats socket /var/lib/haproxy/stats.sock mode 660 level admin process 1
  stats timeout 30s
  user haproxy
  group haproxy
  daemon
  maxconn 200000

defaults
  log global
  mode tcp
  option  tcplog
  timeout connect 5000
  timeout client 50000
  timeout server 50000

frontend ft_redis
  bind :6379 name redis
  default_backend bk_redis
  mode tcp

backend bk_redis
  mode tcp
  option tcp-check
  tcp-check connect
  tcp-check send PING\r\n
  tcp-check expect string +PONG
  tcp-check send info\ replication\r\n
  tcp-check expect string role:master
  tcp-check send QUIT\r\n
  tcp-check expect string +OK
  server redis-1-centos-7 redis-1-centos-7:6379 check inter 1s
  server redis-2-centos-7 redis-2-centos-7:6379 check inter 1s
  server redis-3-centos-7 redis-3-centos-7:6379 check inter 1s

#################################################
# Get Redis nodes status from inside containers #
#################################################


Inside container: proxy-1-centos-7


	 redis-1-centos-7 :

            +PONG
            $454
            # Replication
            role:master
            connected_slaves:2
            slave0:ip=172.28.5.1,port=6379,state=online,offset=200542,lag=1
            slave1:ip=172.28.5.2,port=6379,state=online,offset=200542,lag=1
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:200690
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:1
            repl_backlog_histlen:200690
            
            +OK

	 redis-2-centos-7 :

            +PONG
            $510
            # Replication
            role:slave
            master_host:172.28.5.0
            master_port:6379
            master_link_status:up
            master_last_io_seconds_ago:0
            master_sync_in_progress:0
            slave_repl_offset:200690
            slave_priority:100
            slave_read_only:1
            connected_slaves:0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:200690
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:1
            repl_backlog_histlen:200690
            
            +OK

	 redis-3-centos-7 :

            +PONG
            $512
            # Replication
            role:slave
            master_host:172.28.5.0
            master_port:6379
            master_link_status:up
            master_last_io_seconds_ago:0
            master_sync_in_progress:0
            slave_repl_offset:200690
            slave_priority:100
            slave_read_only:1
            connected_slaves:0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:200690
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:186
            repl_backlog_histlen:200505
            
            +OK

Inside container: proxy-2-debian-9


	 redis-1-centos-7 :

            +PONG
            $454
            # Replication
            role:master
            connected_slaves:2
            slave0:ip=172.28.5.1,port=6379,state=online,offset=200690,lag=0
            slave1:ip=172.28.5.2,port=6379,state=online,offset=200690,lag=0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:200690
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:1
            repl_backlog_histlen:200690
            
            +OK

	 redis-2-centos-7 :

            +PONG
            $510
            # Replication
            role:slave
            master_host:172.28.5.0
            master_port:6379
            master_link_status:up
            master_last_io_seconds_ago:0
            master_sync_in_progress:0
            slave_repl_offset:200690
            slave_priority:100
            slave_read_only:1
            connected_slaves:0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:200690
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:1
            repl_backlog_histlen:200690
            
            +OK

	 redis-3-centos-7 :

            +PONG
            $512
            # Replication
            role:slave
            master_host:172.28.5.0
            master_port:6379
            master_link_status:up
            master_last_io_seconds_ago:0
            master_sync_in_progress:0
            slave_repl_offset:200690
            slave_priority:100
            slave_read_only:1
            connected_slaves:0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:200690
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:186
            repl_backlog_histlen:200505
            
            +OK

####################
# Get actual stats #
####################

Stats for : proxy-1-centos-7
# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,
ft_redis,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,0,,,,,,,,,,,0,0,0,,,0,0,0,0,,,,,,,,
bk_redis,redis-1-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,0,0,6,0,,1,3,1,,0,,2,0,,0,L7OK,0,1,,,,,,,0,,,,0,0,,,,,-1,(tcp-check),,0,0,0,0,
bk_redis,redis-2-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,1,1,4,4,,1,3,2,,0,,2,0,,0,L7TOUT,,1001,,,,,,,0,,,,0,0,,,,,-1, at step 5 of tcp-check (expect string 'role:master'),,0,0,0,0,
bk_redis,redis-3-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,1,1,4,4,,1,3,3,,0,,2,0,,0,L7TOUT,,1001,,,,,,,0,,,,0,0,,,,,-1, at step 5 of tcp-check (expect string 'role:master'),,0,0,0,0,
bk_redis,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,UP,1,1,0,,0,6,0,,1,3,0,,0,,1,0,,0,,,,,,,,,,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,

Stats for : proxy-2-debian-9
# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,agent_status,agent_code,agent_duration,check_desc,agent_desc,check_rise,check_fall,check_health,agent_rise,agent_fall,agent_health,addr,cookie,mode,algo,conn_rate,conn_rate_max,conn_tot,intercepted,dcon,dses,
ft_redis,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,0,,,,,,,,,,,0,0,0,,,0,0,0,0,,,,,,,,,,,,,,,,,,,,,tcp,,0,0,0,,0,0,
bk_redis,redis-1-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,1,1,5,5,,1,3,1,,0,,2,0,,0,L4CON,,0,,,,,,,,,,,0,0,,,,,-1,Connection refused at step 1 of tcp-check (connect),,0,0,0,0,,,,Layer4 connection problem,,2,3,0,,,,172.28.5.0:6379,,tcp,,,,,,,,
bk_redis,redis-2-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,1,1,5,5,,1,3,2,,0,,2,0,,0,L4CON,,0,,,,,,,,,,,0,0,,,,,-1,Connection refused at step 1 of tcp-check (connect),,0,0,0,0,,,,Layer4 connection problem,,2,3,0,,,,172.28.5.1:6379,,tcp,,,,,,,,
bk_redis,redis-3-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,1,1,5,5,,1,3,3,,0,,2,0,,0,L4CON,,0,,,,,,,,,,,0,0,,,,,-1,Connection refused at step 1 of tcp-check (connect),,0,0,0,0,,,,Layer4 connection problem,,2,3,0,,,,172.28.5.2:6379,,tcp,,,,,,,,
bk_redis,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,DOWN,0,0,0,,1,5,5,,1,3,0,,0,,1,0,,0,,,,,,,,,,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,,,,,,,,,,,,,,tcp,roundrobin,,,,,,,


#################################################
# Capture traffic ('tcp-check connect' enabled) #
#################################################

tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
614 packets captured
614 packets received by filter
0 packets dropped by kernel
0 packets captured
0 packets received by filter
0 packets dropped by kernel

####################################################
# Apply Haproxy conf (without 'tcp-check connect') #
####################################################

proxy-1-centos-7.... done
proxy-2-debian-9.... done

########################
# Haproxy conf applied #
########################

global
  log /dev/log local2
  stats socket /var/lib/haproxy/stats.sock mode 660 level admin process 1
  stats timeout 30s
  user haproxy
  group haproxy
  daemon
  maxconn 200000

defaults
  log global
  mode tcp
  option  tcplog
  timeout connect 5000
  timeout client 50000
  timeout server 50000

frontend ft_redis
  bind :6379 name redis
  default_backend bk_redis
  mode tcp

backend bk_redis
  mode tcp
  option tcp-check
  tcp-check send PING\r\n
  tcp-check expect string +PONG
  tcp-check send info\ replication\r\n
  tcp-check expect string role:master
  tcp-check send QUIT\r\n
  tcp-check expect string +OK
  server redis-1-centos-7 redis-1-centos-7:6379 check inter 1s
  server redis-2-centos-7 redis-2-centos-7:6379 check inter 1s
  server redis-3-centos-7 redis-3-centos-7:6379 check inter 1s

#################################################
# Get Redis nodes status from inside containers #
#################################################


Inside container: proxy-1-centos-7


	 redis-1-centos-7 :

            +PONG
            $454
            # Replication
            role:master
            connected_slaves:2
            slave0:ip=172.28.5.1,port=6379,state=online,offset=208576,lag=0
            slave1:ip=172.28.5.2,port=6379,state=online,offset=208576,lag=0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:208576
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:1
            repl_backlog_histlen:208576
            
            +OK

	 redis-2-centos-7 :

            +PONG
            $510
            # Replication
            role:slave
            master_host:172.28.5.0
            master_port:6379
            master_link_status:up
            master_last_io_seconds_ago:0
            master_sync_in_progress:0
            slave_repl_offset:208576
            slave_priority:100
            slave_read_only:1
            connected_slaves:0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:208576
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:1
            repl_backlog_histlen:208576
            
            +OK

	 redis-3-centos-7 :

            +PONG
            $512
            # Replication
            role:slave
            master_host:172.28.5.0
            master_port:6379
            master_link_status:up
            master_last_io_seconds_ago:0
            master_sync_in_progress:0
            slave_repl_offset:208724
            slave_priority:100
            slave_read_only:1
            connected_slaves:0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:208724
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:186
            repl_backlog_histlen:208539
            
            +OK

Inside container: proxy-2-debian-9


	 redis-1-centos-7 :

            +PONG
            $454
            # Replication
            role:master
            connected_slaves:2
            slave0:ip=172.28.5.1,port=6379,state=online,offset=208576,lag=0
            slave1:ip=172.28.5.2,port=6379,state=online,offset=208576,lag=0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:208724
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:1
            repl_backlog_histlen:208724
            
            +OK

	 redis-2-centos-7 :

            +PONG
            $510
            # Replication
            role:slave
            master_host:172.28.5.0
            master_port:6379
            master_link_status:up
            master_last_io_seconds_ago:0
            master_sync_in_progress:0
            slave_repl_offset:208724
            slave_priority:100
            slave_read_only:1
            connected_slaves:0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:208724
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:1
            repl_backlog_histlen:208724
            
            +OK

	 redis-3-centos-7 :

            +PONG
            $512
            # Replication
            role:slave
            master_host:172.28.5.0
            master_port:6379
            master_link_status:up
            master_last_io_seconds_ago:0
            master_sync_in_progress:0
            slave_repl_offset:208724
            slave_priority:100
            slave_read_only:1
            connected_slaves:0
            master_replid:f8eac6c8a17a641b11523474ffa3dbd0af88977a
            master_replid2:0000000000000000000000000000000000000000
            master_repl_offset:208724
            second_repl_offset:-1
            repl_backlog_active:1
            repl_backlog_size:1048576
            repl_backlog_first_byte_offset:186
            repl_backlog_histlen:208539
            
            +OK

####################
# Get actual stats #
####################

Stats for : proxy-1-centos-7
# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,
ft_redis,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,0,,,,,,,,,,,0,0,0,,,0,0,0,0,,,,,,,,
bk_redis,redis-1-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,0,0,6,0,,1,3,1,,0,,2,0,,0,L7OK,0,1,,,,,,,0,,,,0,0,,,,,-1,(tcp-check),,0,0,0,0,
bk_redis,redis-2-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,1,1,5,5,,1,3,2,,0,,2,0,,0,L7TOUT,,1002,,,,,,,0,,,,0,0,,,,,-1, at step 4 of tcp-check (expect string 'role:master'),,0,0,0,0,
bk_redis,redis-3-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,1,1,5,5,,1,3,3,,0,,2,0,,0,L7TOUT,,1001,,,,,,,0,,,,0,0,,,,,-1, at step 4 of tcp-check (expect string 'role:master'),,0,0,0,0,
bk_redis,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,UP,1,1,0,,0,6,0,,1,3,0,,0,,1,0,,0,,,,,,,,,,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,

Stats for : proxy-2-debian-9
# pxname,svname,qcur,qmax,scur,smax,slim,stot,bin,bout,dreq,dresp,ereq,econ,eresp,wretr,wredis,status,weight,act,bck,chkfail,chkdown,lastchg,downtime,qlimit,pid,iid,sid,throttle,lbtot,tracked,type,rate,rate_lim,rate_max,check_status,check_code,check_duration,hrsp_1xx,hrsp_2xx,hrsp_3xx,hrsp_4xx,hrsp_5xx,hrsp_other,hanafail,req_rate,req_rate_max,req_tot,cli_abrt,srv_abrt,comp_in,comp_out,comp_byp,comp_rsp,lastsess,last_chk,last_agt,qtime,ctime,rtime,ttime,agent_status,agent_code,agent_duration,check_desc,agent_desc,check_rise,check_fall,check_health,agent_rise,agent_fall,agent_health,addr,cookie,mode,algo,conn_rate,conn_rate_max,conn_tot,intercepted,dcon,dses,
ft_redis,FRONTEND,,,0,0,2000,0,0,0,0,0,0,,,,,OPEN,,,,,,,,,1,2,0,,,,0,0,0,0,,,,,,,,,,,0,0,0,,,0,0,0,0,,,,,,,,,,,,,,,,,,,,,tcp,,0,0,0,,0,0,
bk_redis,redis-1-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,UP,1,1,0,0,0,6,0,,1,3,1,,0,,2,0,,0,L7OK,0,1,,,,,,,,,,,0,0,,,,,-1,(tcp-check),,0,0,0,0,,,,Layer7 check passed,,2,3,4,,,,172.28.5.0:6379,,tcp,,,,,,,,
bk_redis,redis-2-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,1,1,5,5,,1,3,2,,0,,2,0,,0,L7TOUT,,1001,,,,,,,,,,,0,0,,,,,-1, at step 4 of tcp-check (expect string 'role:master'),,0,0,0,0,,,,Layer7 timeout,,2,3,0,,,,172.28.5.1:6379,,tcp,,,,,,,,
bk_redis,redis-3-centos-7,0,0,0,0,,0,0,0,,0,,0,0,0,0,DOWN,1,1,0,1,1,4,4,,1,3,3,,0,,2,0,,0,* L7TOUT,,1001,,,,,,,,,,,0,0,,,,,-1,,,0,0,0,0,,,,Layer7 timeout,,2,3,0,,,,172.28.5.2:6379,,tcp,,,,,,,,
bk_redis,BACKEND,0,0,0,0,200,0,0,0,0,0,,0,0,0,0,UP,1,1,0,,0,6,0,,1,3,0,,0,,1,0,,0,,,,,,,,,,,,,,0,0,0,0,0,0,-1,,,0,0,0,0,,,,,,,,,,,,,,tcp,roundrobin,,,,,,,


##################################################
# Capture traffic ('tcp-check connect' disabled) #
##################################################

tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
624 packets captured
624 packets received by filter
0 packets dropped by kernel
619 packets captured
620 packets received by filter
0 packets dropped by kernel
